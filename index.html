<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Digit Classifier</title>
  <!--link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Nunito:400,400i,700"-->
</head>

<body onload="load()">
  <style type="text/css" media="screen">
    html,
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: black;
    }
  </style>
  <canvas id="canvas" width="400" height="400" style="background-color:black"></canvas>
  <div style="display: none">'
    <img src="background.svg" id="background" width="3360" height="1952">
    <canvas id="scalingcanvas" width="28" height="28" style="background-color:white"></canvas>
    <canvas id="finalcanvas" width="28" height="28" style="background-color:white"></canvas>
  </div>
  <script src="web-font-loader.js"></script>
  <script>
    function load() {
      WebFont.load({
        google: {
          families: ['Nunito']
        },
        active: function() {
          load2();
        },
      });
    }

    function load2() {
      canvas = document.getElementById("canvas")
      w = 3360
      h = 1952
      xScale = window.innerWidth / w
      yScale = window.innerHeight / h
      if (Math.abs((xScale / yScale) - 1) > 0.1) {
        xScale = yScale = Math.min(xScale, yScale)
      }
      var digit
      canvas.width = w * xScale;
      canvas.height = h * yScale;
      ctx = canvas.getContext("2d");
      ctx.scale(xScale, yScale);
      mouseX = w / 2
      mouseY = h / 2
      run()
    }

    function run() {
      ctx.fillStyle = "#FFF"
      ctx.fillRect(0, 0, w, h)
      ctx.drawImage(document.getElementById("background"), 0, 0, w, h) //This is see through on its canvas
      mouseDown = false
      lines = []
      ctx.lineWidth = 110
      ctx.lineJoin = ctx.lineCap = 'round'
      var jjj = NN();
      var jj = JSON.parse(jjj)
      net = new nnet.Net();
      net.fromJSON(jj)
      setInterval(whatNumber, 200)
      window.addEventListener("mousedown", function(event) {
        mouseDown = true
        lines.push([{
          x: event.x / xScale,
          y: event.y / yScale
        }])
        if (event.x / xScale < 1400 && event.y / yScale > 1400) {
          ctx.fillStyle = "#FFF"
          ctx.fillRect(0, 0, w, h)
          ctx.drawImage(document.getElementById("background"), 0, 0, w, h)
          lines = []
          digit = undefined
        }
      });
      window.addEventListener("mouseup", function(event) {
        mouseDown = false
      });
      canvas.addEventListener("mousemove", function(event) {
        if (mouseDown) {
          ctx.fillStyle = "#FFF"
          ctx.fillRect(0, 0, w, h)
          if (typeof lines === "undefined") lines = []
          lines[lines.length - 1].push({
            x: event.x / xScale,
            y: event.y / yScale
          })

          for (var j = 0; j < lines.length; j++) {
            ctx.beginPath();
            ctx.moveTo(lines[j][0].x, lines[j][0].y);
            for (var i = 1; i < lines[j].length; i++) {
              ctx.lineTo(lines[j][i].x, lines[j][i].y);
            }
            ctx.stroke();
          }
        }
        ctx.drawImage(document.getElementById("background"), 0, 0, w, h)
        if (typeof digit === "undefined") return
        ctx.fillStyle = "#333333"
        ctx.font = '800px Nunito';
        ctx.textAlign = 'centre';
        ctx.fillText(digit.toString(), 450, 1300);
      });
    }

    function whatNumber() {
      var imageData = ctx.getImageData(Math.floor(1600 * xScale), Math.floor(150 * yScale), Math.floor(1600 * xScale), Math.floor(1600 * yScale)); //1600 by 1600, CHANGE!!
      var simple = []
      for (var i = 0; i < imageData.data.length; i += 4) {
        simple.push(imageData.data[i])
      }
      var grid = []
      var side = Math.sqrt(simple.length)
      for (var i = 0; i < side; i++) {
        grid.push(simple.slice(side * i, side * (i + 1)))
      }
      //Edges of non-white values (< 255)
      var minX = "red"
      var minY = "red"
      var maxX = "red"
      var maxY = "red"

      for (var i = 0; i < grid.length; i++) {
        for (var j = 0; j < grid.length; j++) {
          if (grid[i][j] < 255 && minY == "red") {
            minY = i
          }
          if (grid[j][i] < 255 && minX == "red") {
            minX = i
          }
        }
      }

      for (var i = grid.length - 1; i >= 0; i--) {
        for (var j = grid.length - 1; j >= 0; j--) {
          if (grid[i][j] < 255 && maxY == "red") {
            maxY = i
          }
          if (grid[j][i] < 255 && maxX == "red") {
            maxX = i
          }
        }
      }
      if (maxX == "red") {
        ctx.drawImage(document.getElementById("background"), 0, 0, w, h);
        return
      }
      var boxWidth = Math.max(maxX - minX, maxY - minY)
      var topLeft = {
        x: Math.floor((maxX + minX - boxWidth) / 2),
        y: Math.floor((maxY + minY - boxWidth) / 2)
      }
      topLeft.x += Math.floor(1600 * xScale)
      topLeft.y += Math.floor(150 * yScale)
      //Get image data again??? easier than looping through

      ctx.fillStyle = "#FFF"
      ctx.fillRect(0, 0, 1560, h)
      ctx.fillRect(3225, 0, 1600, h)
      ctx.fillRect(0, 0, w, 140)
      ctx.fillRect(0, 1805, w, 1000)
      var xx = new nnet.Vol(24, 24, 1)
      var squareData = ctx.getImageData(topLeft.x, topLeft.y, boxWidth, boxWidth);
      var c = document.getElementById("scalingcanvas");
      c.width = Math.sqrt(squareData.data.length/4)
      c.height = c.width
      var cunt = c.getContext("2d");
      cunt.putImageData(squareData, 0, 0)

      var fc = document.getElementById("finalcanvas");
      var funt = fc.getContext("2d");
      funt.fillStyle = "#FFF"
      funt.fillRect(0, 0, w, h)
      funt.drawImage(c, 2, 2, 20, 20)

      var abc = funt.getImageData(0, 0, 24, 24)
      var inputLayer = []
      for (var i = 0; i < abc.data.length; i += 4) {
        inputLayer.push(255-abc.data[i])
      }
      xx.w = inputLayer
      fx = net.forward(xx).w;
      digit = fx.indexOf(Math.max(...fx))
      ctx.drawImage(document.getElementById("background"), 0, 0, w, h)
      ctx.fillStyle = "#333333"
      ctx.font = '800px Nunito';
      ctx.textAlign = 'centre';
      ctx.fillText(digit.toString(), 450, 1300);
    }
  </script>
</body>

</html>
